#!/bin/sh

# Pre-push hook: Enforces version bump before pushing to main
#
# Workflow:
#   1. Make your changes, commit them
#   2. Run: npm run release (bumps version, updates changelog, commits, tags)
#   3. Run: VERSION_BUMP=0 git push --follow-tags
#
# The VERSION_BUMP=0 confirms you've handled versioning intentionally.

# VERSION_BUMP=0 means "I've handled versioning, allow the push"
if [ "$VERSION_BUMP" = "0" ]; then
  exit 0
fi

# Read push info from stdin to detect pushes TO main (not just FROM main)
# Format: <local ref> <local sha> <remote ref> <remote sha>
pushing_to_main=false
local_sha=""

while read local_ref local_sha remote_ref remote_sha; do
  if [ "$remote_ref" = "refs/heads/main" ]; then
    pushing_to_main=true
    break
  fi
done

# Only applies when pushing to main branch
if [ "$pushing_to_main" = "false" ]; then
  exit 0
fi

# Check for version tag on the commit being pushed
latest_tag=$(git describe --tags --abbrev=0 "$local_sha" 2>/dev/null || echo "")

if [ -z "$latest_tag" ]; then
  echo ""
  echo "══════════════════════════════════════════════════════════"
  echo "❌ PUSH BLOCKED: No version tags found"
  echo "══════════════════════════════════════════════════════════"
  echo ""
  echo "Before pushing to main, create a release:"
  echo ""
  echo "  npm run release -- --first-release   # First time only"
  echo "  VERSION_BUMP=0 git push --follow-tags"
  echo ""
  exit 1
fi

# Check for commits since last tag on the ref being pushed
new_commits=$(git rev-list "$latest_tag".."$local_sha" --count 2>/dev/null || echo "0")

if [ "$new_commits" -gt 0 ]; then
  echo ""
  echo "══════════════════════════════════════════════════════════"
  echo "❌ PUSH BLOCKED: $new_commits commit(s) since $latest_tag"
  echo "══════════════════════════════════════════════════════════"
  echo ""
  echo "Before pushing to main, bump the version:"
  echo ""
  echo "  npm run release                      # Bump version & changelog"
  echo "  VERSION_BUMP=0 git push --follow-tags"
  echo ""
  echo "Or skip versioning (docs/config only):"
  echo ""
  echo "  VERSION_BUMP=0 git push"
  echo ""
  exit 1
fi

# Ref being pushed is tagged - push is fine
exit 0
