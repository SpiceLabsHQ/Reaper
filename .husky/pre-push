#!/bin/sh

# Pre-push hook: Enforces version bump before pushing to main
#
# Workflow:
#   1. Make your changes, commit them
#   2. Run: npm run release (bumps version, updates changelog, commits, tags)
#   3. Run: VERSION_BUMP=0 git push --follow-tags
#
# The VERSION_BUMP=0 confirms you've handled versioning intentionally.

branch=$(git rev-parse --abbrev-ref HEAD)

# Only applies to main branch
if [ "$branch" != "main" ]; then
  exit 0
fi

# VERSION_BUMP=0 means "I've handled versioning, allow the push"
if [ "$VERSION_BUMP" = "0" ]; then
  exit 0
fi

# Check for version tag
latest_tag=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

if [ -z "$latest_tag" ]; then
  echo ""
  echo "══════════════════════════════════════════════════════════"
  echo "❌ PUSH BLOCKED: No version tags found"
  echo "══════════════════════════════════════════════════════════"
  echo ""
  echo "Before pushing to main, create a release:"
  echo ""
  echo "  npm run release -- --first-release   # First time only"
  echo "  VERSION_BUMP=0 git push --follow-tags"
  echo ""
  exit 1
fi

# Check for commits since last tag
new_commits=$(git rev-list "$latest_tag"..HEAD --count 2>/dev/null || echo "0")

if [ "$new_commits" -gt 0 ]; then
  echo ""
  echo "══════════════════════════════════════════════════════════"
  echo "❌ PUSH BLOCKED: $new_commits commit(s) since $latest_tag"
  echo "══════════════════════════════════════════════════════════"
  echo ""
  echo "Before pushing to main, bump the version:"
  echo ""
  echo "  npm run release                      # Bump version & changelog"
  echo "  VERSION_BUMP=0 git push --follow-tags"
  echo ""
  echo "Or skip versioning (docs/config only):"
  echo ""
  echo "  VERSION_BUMP=0 git push"
  echo ""
  exit 1
fi

# HEAD is tagged - push is fine
exit 0
