#!/bin/sh

# Pre-push hook for automated semantic versioning
#
# Behavior:
#   - Feature branches: No interference (exits immediately)
#   - Main branch with VERSION_BUMP=1: Creates release and pushes with tags
#   - Main branch with VERSION_BUMP=0: Skips version check entirely
#   - Main branch without env var: Fails with instructions (automation-friendly)
#
# For Claude Code agents:
#   - Use VERSION_BUMP=1 to auto-release before pushing
#   - Use VERSION_BUMP=0 to push without version bump (e.g., docs-only changes)

# Prevent recursive hook execution
# When we call git push from within this hook, it would trigger pre-push again
if [ "$_VERSION_BUMP_HOOK_RUNNING" = "1" ]; then
  exit 0
fi
export _VERSION_BUMP_HOOK_RUNNING=1

# Get the branch being pushed
branch=$(git rev-parse --abbrev-ref HEAD)

# Only run on main branch - feature branches pass through immediately
if [ "$branch" != "main" ]; then
  exit 0
fi

# Get remote being pushed to (for the push command later)
remote=$(git rev-parse --abbrev-ref --symbolic-full-name @{u} 2>/dev/null | cut -d/ -f1)
remote=${remote:-origin}

# VERSION_BUMP=1: Auto-release mode
# Creates version bump commit, tags it, and pushes everything including tags
if [ "$VERSION_BUMP" = "1" ]; then
  echo "══════════════════════════════════════════════════════════"
  echo "VERSION_BUMP=1: Running automated release..."
  echo "══════════════════════════════════════════════════════════"

  # Run the release (bumps version, updates changelog, commits, tags)
  if ! npm run release; then
    echo ""
    echo "❌ RELEASE FAILED"
    echo "   npm run release exited with error"
    echo "   Fix the issue and retry: VERSION_BUMP=1 git push"
    exit 1
  fi

  echo ""
  echo "✅ Release commit and tag created locally"
  echo "   Pushing to $remote with --follow-tags..."
  echo ""

  # Push with follow-tags to include the new release commit and tag
  if ! git push --follow-tags "$remote" "$branch"; then
    echo ""
    echo "❌ PUSH FAILED"
    echo "   Release was created locally but push failed"
    echo "   Retry with: git push --follow-tags $remote $branch"
    exit 1
  fi

  echo ""
  echo "══════════════════════════════════════════════════════════"
  echo "✅ RELEASE COMPLETE"
  echo "   Version bumped, tagged, and pushed to $remote/$branch"
  echo "══════════════════════════════════════════════════════════"

  # Exit 1 to abort the original push (we already pushed everything)
  # This prevents a duplicate/redundant push attempt
  exit 1
fi

# VERSION_BUMP=0: Explicit skip mode
# Use when pushing changes that don't warrant a version bump (docs, config, etc.)
if [ "$VERSION_BUMP" = "0" ]; then
  echo "VERSION_BUMP=0: Skipping version check (explicit skip)"
  exit 0
fi

# No VERSION_BUMP env var set - check if version bump is needed and provide guidance

# Get latest version tag
latest_tag=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

if [ -z "$latest_tag" ]; then
  echo ""
  echo "══════════════════════════════════════════════════════════"
  echo "❌ PUSH BLOCKED: No version tags found"
  echo "══════════════════════════════════════════════════════════"
  echo ""
  echo "This repository has no version tags. Before pushing to main,"
  echo "you must either create the first release or explicitly skip."
  echo ""
  echo "Options:"
  echo ""
  echo "  1. Create first release (recommended for new projects):"
  echo "     npm run release -- --first-release"
  echo "     git push --follow-tags"
  echo ""
  echo "  2. Auto-release with version bump:"
  echo "     VERSION_BUMP=1 git push"
  echo ""
  echo "  3. Skip version check (push without tag):"
  echo "     VERSION_BUMP=0 git push"
  echo ""
  exit 1
fi

# Check for new commits since last tag
new_commits=$(git rev-list "$latest_tag"..HEAD --count 2>/dev/null || echo "0")

if [ "$new_commits" -gt 0 ]; then
  # Get commit types to help decide if version bump is needed
  commit_summary=$(git log "$latest_tag"..HEAD --pretty=format:"%s" | head -5)

  echo ""
  echo "══════════════════════════════════════════════════════════"
  echo "❌ PUSH BLOCKED: $new_commits commit(s) since $latest_tag"
  echo "══════════════════════════════════════════════════════════"
  echo ""
  echo "Recent commits:"
  echo "$commit_summary" | while read -r line; do echo "  - $line"; done
  [ "$new_commits" -gt 5 ] && echo "  ... and $((new_commits - 5)) more"
  echo ""
  echo "Options:"
  echo ""
  echo "  1. Auto-release (bumps version based on conventional commits):"
  echo "     VERSION_BUMP=1 git push"
  echo ""
  echo "  2. Skip version bump (for docs/config changes):"
  echo "     VERSION_BUMP=0 git push"
  echo ""
  echo "  3. Manual release with dry-run preview:"
  echo "     npm run release:dry-run   # Preview changes"
  echo "     npm run release           # Create release"
  echo "     git push --follow-tags    # Push with tag"
  echo ""
  exit 1
fi

# No new commits since last tag - push is fine
exit 0
