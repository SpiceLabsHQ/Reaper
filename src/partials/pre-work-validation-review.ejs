<% var _requireTestResults = (typeof requireTestResults === 'undefined' || requireTestResults !== false); -%>
<% var _hasReviewContext = (typeof reviewContext !== 'undefined' && reviewContext); -%>
<% var _sectionCount = _hasReviewContext ? '5' : '4'; -%>
## PRE-WORK VALIDATION (MANDATORY)

**CRITICAL**: Before ANY work begins, validate ALL <%= _sectionCount %> requirements:

### 1. TASK Identifier
- **Required**: Task identifier (any format)
- **Format**: Flexible - accepts PROJ-123, repo-a3f, #456, sprint-5-auth
- **If Missing**: EXIT with "ERROR: Need task identifier"

### 2. WORKING_DIR (Code Location)
- **Required Format**: ./trees/[task-id]-description (or project root if no worktree)
- **If Missing**: EXIT with "ERROR: Working directory required (e.g., ./trees/PROJ-123-review)"
- **Validation**: Path must exist and contain the code to review
- **Purpose**: Directory where code changes are located - agent does NOT create this, only works within it
- **Note**: This agent does NOT manage worktrees - it reviews code in the provided directory

### 3. PLAN_CONTEXT (Implementation Plan)
- **Required**: The full implementation plan that guided development
- **Accepted Sources** (any of the following):
  - Plan content passed directly in prompt
  - File path to plan (e.g., `@plan.md`, `./plans/feature-plan.md`)
  - Jira issue key (agent will fetch details)
  - Beads issue key (agent will fetch details)
  - Inline detailed description of what was planned
- **If Missing**: EXIT with "ERROR: PLAN_CONTEXT required"
- **Purpose**: Verify that actual code changes match the planned implementation
<% if (_requireTestResults) { -%>

### 4. TEST_RUNNER_RESULTS (Test Validation Output)
- **Required**: Full JSON output from test-runner agent
- **Must Include**: test_exit_code, coverage_percentage, lint_exit_code, test_metrics
- **If Missing**: EXIT with "ERROR: TEST_RUNNER_RESULTS required (full JSON from test-runner agent)"
- **Trust Policy**: Trust this data completely - do NOT re-run tests unless investigating a specific problem
- **Purpose**: Use for context only (what passed, coverage level, lint status)
<% } else { -%>

### 4. PRIOR_GATE_RESULTS (Optional Prior Gate Output)
- **Optional**: JSON output from any prior quality gate agent (e.g., test-runner, security-auditor)
- **If Provided**: Use as additional context for review (what passed, what was flagged)
- **If Not Provided**: Proceed without prior gate context — this review is the first gate
- **Trust Policy**: Trust prior gate data completely — do not re-run prior gate checks
- **Purpose**: Inform review with upstream findings when available
<% } -%>
<% if (_hasReviewContext) { -%>

### 5. REVIEW_CONTEXT (Review Focus Areas)
- **Optional**: Comma-separated list specifying what to evaluate
- **Values**: "SOLID" (code quality), "plan_adherence" (plan vs implementation), "conventions" (project conventions)
- **Default**: "<%= reviewContext %>"
- **Purpose**: Allows callers to scope the review to relevant criteria for the work type
<% } -%>

**EXIT PROTOCOL**:
If any requirement is missing, agent MUST exit immediately with specific error message.
